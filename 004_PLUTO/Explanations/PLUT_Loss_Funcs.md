### 学習時と推論時の損失計算の違い

学習時と推論時の損失計算は、しばしば異なる目的を持ち、異なる計算方法が用いられます。以下に、学習時と推論時の損失計算の違いを、数式の違いも含めて説明します。

#### 学習時の損失計算
学習時には、モデルが訓練データに基づいてパラメータを更新するため、損失関数が用いられます。例えば、以下のような損失関数が使われます：

1. **模倣損失（Imitation Loss）**：
   ```math
   \mathcal{L}_i = \mathcal{L}_{\text{reg}} + \mathcal{L}_{\text{cls}},
   ```
   - $\mathcal{L}_{\text{reg}}$ は軌道回帰のためのスムースL1損失
   - $\mathcal{L}_{\text{cls}}$ はスコア分類のためのクロスエントロピー損失

2. **予測損失（Prediction Loss）**：
   ```math
   \mathcal{L}_p = \text{L1}_{\text{smooth}}(P_{1:\text{NA}}, P^{\text{gt}}_{1:\text{NA}}),
   ```
   - 予測された軌道 $P_{1:\text{NA}}$ と地上真理の軌道 $P^{\text{gt}}_{1:\text{NA}}$ の間の誤差を計算します。

学習時には、これらの損失が合計され、モデルのパラメータを更新するために使用されます。通常、損失は複数のコンポーネントから成り、それぞれが異なるタスクをカバーしています。

#### 推論時の損失計算
推論時には、モデルのパラメータは固定されており、通常は損失計算が行われません。推論の目的は、学習したモデルを用いて新しいデータに対する予測を行うことです。従って、推論時には、損失関数そのものを計算することはなく、予測結果が評価されるのみです。例えば、予測された軌道がどれだけ正確であるか、あるいは意図した行動が達成されたかを評価します。

ただし、推論時においても一部のシステムでは、「評価損失」を計算することがあります。これは、推論のパフォーマンスを評価するために、地上真理と予測の間の誤差を計算するものです。この場合、学習時と同じ損失関数が用いられることが一般的ですが、パラメータ更新は行われません。

#### 具体的な数式の違い
学習時には、複数の損失項（例：模倣損失、予測損失、補助損失など）が合計され、次のような総合的な損失が計算されます：
```math
L = w_1\mathcal{L}_i + w_2\mathcal{L}_p + w_3\mathcal{L}_{\text{aux}} + w_4\mathcal{L}_c,
```
ここで、$w_1, w_2, w_3, w_4$ はそれぞれの損失項に対する重みです。

推論時には、基本的には上記の損失項は計算されず、評価のために地上真理との誤差が測定されるのみです。

---

このように、学習時と推論時の損失計算は目的が異なるため、計算される内容や方法にも違いがあります。学習時には損失を用いてモデルを最適化し、推論時には損失ではなく予測の性能を評価することに重点が置かれます。
