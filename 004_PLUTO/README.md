# PLUTO: 
Contrastive Imitation Learning for Longitudinal-Lateral Coupling Decision-making in Urban Autonomous Driving

# 概要

## 1. 序論

### 1.1 背景と動機
この節では、都市部の自動運転車（AV）が直面する課題について説明しています。具体的には、複雑な交通状況や多様なエージェントの存在が、自動運転システムの計画と意思決定における大きな障壁となっていることが指摘されています。従来の手法では、特定の場面に適したルールベースのアプローチや、学習に基づくアプローチが存在するが、これらはそれぞれ限界を持っています。この論文では、模倣学習とコントラスト学習を組み合わせた新しい手法を提案し、これらの課題に対処します。

## 2. 関連研究

この章では、自動運転の分野における関連する研究をレビューしています。ルールベース、学習ベース、およびハイブリッド手法の利点と欠点が分析されています。また、模倣学習や強化学習の技術がどのように進化してきたかについても説明されています。

## 3. 手法

### 3.1 問題定式化
PLUTOのモデルは、AVが動的な都市環境で意思決定を行うための枠組みを提供します。具体的には、AVの周囲に存在する動的なエージェント、静的な障害物、高精度マップ、および交通信号の状態を考慮に入れています。これらの情報を元に、AVが将来の複数の軌道を生成し、シーンの文脈を統合して最適な軌道を選択します【21:5†source】。

### 3.2 入力表現とシーンエンコーディング

エージェントの履歴情報や静的障害物の特徴をエンコードするために、 <span style="color:red;"> 特徴ピラミッドネットワーク（FPN）</span> を使用しています。これにより、エージェントの位置、方向、速度などの情報が効率的に抽出されます【21:5†source】。

### 3.3 軌道デコーディング
PLUTOは、横方向と縦方向の<span style="color:red;">セルフアテンションメカニズム</span>を用いて、さまざまな軌道を生成します。最終的に、デコーダの出力を使用して、将来の軌道点とそれに関連するスコアを決定します【21:6†source】。

## 4. コントラスト模倣学習フレームワーク

### 4.1 フレームワークの概要
このフレームワークは、データ拡張とコントラスト学習を組み合わせて、モデルがより良い行動を学習できるように設計されています。具体的には、正のサンプルと負のサンプルを生成し、それらの間で<span style="color:red">コントラスト損失</span>を計算することで、モデルの学習を強化します【21:16†source】。

### 4.2 データ拡張
状態の摂動や非相互作用エージェントの削除など、6つの拡張戦略が提案されています。これにより、モデルはさまざまなシナリオでの堅牢性を向上させます【21:12†source】。

## 5. 結果と考察

### 5.1 最先端技術との比較
PLUTOは、他の最先端の手法と比較して、さまざまな評価指標で優れた性能を示しています。特に、閉ループシナリオでの性能が向上しています【21:0†source】。

### 5.2 アブレーション研究
PLUTOの各コンポーネントの影響を分析するためのアブレーション研究が実施されています。これにより、<span style="color:red">状態ドロップアウトエンコーダー</span>や<span style="color:red">補助損失</span>が、モデルの性能向上に寄与していることが確認されています【21:18†source】。

## 6. 結論

この章では、PLUTOが自動運転分野における新しいベンチマークを設定し、学習ベースの計画における重要な進展を示していると結論付けています。今後の研究課題として、複数モードの予測を計画に統合する方法の探求が挙げられています【21:16†source】。

---

# 各章ごとに詳しくまとめる

# 1. 序論

## 1.1 背景と動機

学習ベースの計画（Learning-based planning）は、自動運転において拡張性のあるアプローチとして注目されており、多くの研究が行われています[ref1]()。特に、模倣学習に基づく計画は、シミュレーションや実世界の応用で成功を収めています。しかし、学習ベースの計画の効果はまだ不十分です。<span style="color:red">2023年のnuPlan計画チャレンジでは、従来のルールベースの計画が全ての学習ベースの代替手法を凌駕し、優勝しました</span>。この論文では、学習ベースの計画における主要な課題を明らかにし、これらの課題に対処するための新しいソリューションを提案しています。

## 1.2 学習ベースの計画の課題

1. **マルチモーダル運転行動の取得**: 学習ベースのプランナーは、車線維持のような縦方向のタスクの学習に優れている一方で、車線変更や障害物の回避といった横方向のタスクには苦戦しています。この欠陥は、<span style="color:red">モデルの設計における明確な横方向行動モデリングの欠如</span>に起因しています[ref2]()。

2. **純粋な模倣学習の限界**: 純粋な模倣学習には、学習のショートカットをとる傾向や、分布のシフト、因果混同などの問題が内在しています。特に、自動運転のような安全性が重要な領域では、<span style="color:red">トレーニング中に明示的な制約を課すことが不可欠</span>です。本研究では、微分可能な補間に基づく<span style="color:red">新しい補助損失計算方法を導入</span>し、これらの問題に対処します[ref3]()。

3. **新しいデータ拡張手法**: モデルがオープンループトレーニングとクローズドループテストを経る際に、<span style="color:red">時間とともにエラーが蓄積し、入力データがトレーニング分布から逸脱することがあります</span>。 <span style="color:red">データ拡張</span>はこれらの問題を軽減するために広く用いられており、効果が証明されています。さらに、本研究では運転行動を調整し、相互作用の学習を強化するための新しい拡張手法を提案します[ref4]()。


# 2. 関連研究

## 2.1 模倣学習に基づく計画

<span style="color:red">模倣学習に基づく計画は、経験豊富なドライバーの政策をクローン化することにより、自動運転の最も直接的かつスケーラブルな解決策</span>とされています。今日のデータの豊富さと経済性を考慮すると、この方法は非常に有望です。特に人気があるのはエンドツーエンド（E2E）運転のアプローチで、これは生センサーデータから直接運転政策を学習します。この手法は、比較的短期間で大きな進歩を遂げました。最初は、カメラ入力を制御政策にマッピングする畳み込みニューラルネットワーク（CNN）ベースのモデルに焦点が当てられていましたが[ref5]()、その後、マルチセンサーフュージョンを活用したより高度な方法に進化しました[ref6]()。

<span style="color:red">最近の開発では、LAVやUniADといった団体が主導し、モジュールベースのE2Eアーキテクチャにシフト</span>しています。このアプローチは、認識、予測、計画のプロセスを統合したモデルを形成します。しかし、これらの多くのE2E戦略は、トレーニングと評価の両方で高忠実度のシミュレーション環境に大きく依存しています。その結果、シミュレーションされたエージェントのリアリズムと多様性の欠如、不完全なルールベースの専門家への依存、および現実世界での適用性のためのシミュレーションと現実のギャップを埋める必要性などの問題が生じています[ref7]()。

参考情報 : [LAV & UniAD](./Explanations/LAV_UniAD.md)

この論文では、<span style="color:red">事前認識結果を入力機能として使用する「ミッド・トゥ・ミッド」アプローチに焦点を当てています</span>。この方法の主な利点は、シミュレーションから現実への転送の懸念を排除し、実世界のデータでモデルを計画の学習に集中させることができる点にあります。<span style="color:red">ChauffeurNet、SafetyNet、UrbanDriverなどの先駆的なアプローチ</span>は、実世界環境で自動運転車を操作する能力を示し、その後の研究はこれらの基盤の上に構築されてきました。これらのアプローチは、動作予測コミュニティにおける進展、特に予測タスクで優れた性能を発揮するベクトルベースのモデルの採用から大きな利益を得ています。しかし、<span style="color:red">これらのモデルの多くは、計画タスクに固有の特性、例えば閉ループテストや積極的な意思決定能力の必要性を見落としています。</span>対照的に、我々の提案するフレームワークは、計画のために最初から設計されています。ネットワークは、クエリベースのアーキテクチャを通じて縦方向と横方向の運転行動を共同でモデル化し、柔軟で多様な運転スタイルを可能にしています[ref8]()。

## 2.2 対照学習

<span style="color:red">対照学習は、類似したペアと異なるペアを比較することで表現を学習するフレームワーク</span>であり、コンピュータビジョンや自然言語処理で大きな成功を収めています。自動運転の文脈では、運動予測のためのいくつかの試みがなされています。<span style="color:red">Social NCE</span>は、歩行者の動きの予測において目標生成を導くために<span style="color:red">社会的対照損失</span>を導入しました。<span style="color:red">Marahら</span>は、学習された軌道埋め込みを洗練するために<span style="color:red">アクションベースの対照学習損失</span>を利用しました。<span style="color:red">FEND</span>はこのアプローチを使用して<span style="color:red">ロングテール軌道を認識</span>しました。<span style="color:red">これらの研究は、正と負の例の慎重な選択を通じてモデルにドメイン固有の知識を組み込む上での対照学習の力を強調</span>しています[ref9]()。



# 3. Methodology（手法）

[数式の詳細解説](./Explanations/Sec3_Equation.md)

## **3.1 モデルアーキテクチャ**

**シーンエンコーディング**
- **入力情報の統合**:
  - PLUTOモデルは、自動運転車（AV）自身の状態、周囲のエージェント（他の車両や歩行者など）の情報、静的障害物（道路標識や建物など）、および地図情報（レーンや交差点など）を入力として受け取ります。
  - これらの情報は、まず個別にエンコーディングされ、それぞれの埋め込みベクトルが生成されます。例えば、エージェントの状態はその位置、速度、方向などの情報を含む特徴ベクトルに変換されます。

- **統合テンソルの生成**:
  - 各エンティティ（AV、エージェント、障害物、ポリライン）の埋め込みベクトルが統合され、シーン全体を表現する統合テンソル $E_0$ が生成されます。このテンソルは、モデルがシーン全体を理解するための基盤となります。
  - 統合テンソルは、各要素が互いにどのように関連しているかを捉えるために、トランスフォーマーエンコーダに入力されます。エンコーダは、シーン内の複数のエージェント間の相互作用を捉え、複雑なシーンの文脈を把握します。

**横方向および縦方向のクエリ**
- **クエリ生成**:
  - シーン全体を理解するためには、特定の運転行動に対応するクエリを生成する必要があります。PLUTOモデルは、横方向（Lateral）と縦方向（Longitudinal）の2種類のクエリを生成します。
  - 横方向クエリ（$Q_{lat}$）は、車両の左右の動きやレーン変更などに関連し、縦方向クエリ（$Q_{lon}$）は、車両の加速・減速や前後の動きに関連します。

- **クエリの投影と結合**:
  - これらのクエリは、それぞれMLPにより適切な次元に投影されます。このプロセスにより、横方向と縦方向のクエリが統合され、初期クエリセット $Q_0$ が生成されます。このクエリセットは、後続のデコーダプロセスで使用されます。

## **3.2 セルフアテンションとクロスアテンション**

参考 : [セルフアテンションとクロスアテンション](./Explanations/Self_Cross_Attension.md)

**セルフアテンションメカニズム**
- **横方向セルフアテンション**:
  - 横方向のクエリ（$Q_{lat}$）に対してセルフアテンションが適用されます。セルフアテンションメカニズムは、クエリ内の各要素が他の要素とどのように関連しているかを学習し、重要な情報を強調します。
  - 例えば、あるクエリが特定のレーン変更に関係している場合、そのレーンに関連する他の要素（例えば隣接車両やレーン境界）との関連性が高まります。数式では以下のように表現されます：
  ```math
  Q'_{i-1} = \text{SelfAttn}(Q_{i-1}, \text{dim} = 0)
  ```
  - ここで、$Q_{i-1}$ は前のステップのクエリで、$Q'_{i-1}$ はセルフアテンションを適用した後のクエリです。

- **縦方向セルフアテンション**:
  - 同様に、縦方向のクエリ（$Q_{lon}$）に対してもセルフアテンションが適用されます。これにより、車両の前後の動きや加減速に関連する情報が強調されます。数式では以下のように表現されます：
  ```math
  \hat{Q}_{i-1} = \text{SelfAttn}(Q'_{i-1}, \text{dim} = 1)
  ```
  - ここで、$Q'_{i-1}$ は横方向セルフアテンションを適用した後のクエリで、$\hat{Q}_{i-1}$ は縦方向セルフアテンションを適用した後のクエリです。

**クロスアテンション**
- **シーンエンコーディングとの統合**:
  - セルフアテンションを適用した後のクエリは、シーンエンコーディングテンソル $E_{enc}$ とクロスアテンションを行います。このプロセスにより、シーン全体の文脈がクエリに反映され、最適な運転軌道が導き出されます。
  ```math
  Q_i = \text{CrossAttn}(\hat{Q}_{i-1}, E_{enc}, E_{enc})
  ```
  - ここで、$\hat{Q}_{i-1}$ は縦方向セルフアテンションを適用した後のクエリで、$E_{enc}$ はシーン全体を表すエンコーディングテンソルです。この操作により、各クエリがシーン内の重要な情報と結び付けられます。

## **3.3 軌道とスコアの生成**

**軌道生成**
- **MLP(=Multi-Layer Perceptron)による軌道の予測**:
  - クロスアテンションを経たクエリは、軌道生成用のMLPに入力され、最終的な軌道 $T_0$ が生成されます。この軌道は、車両が次に進むべき具体的な位置座標（x, y）として表されます。
  ```math
  T_0 = \text{MLP}_{traj}(Q_i)
  ```
  - この式では、$Q_i$ は最終的にクロスアテンションを適用した後のクエリを指し、$\text{MLP}_{traj}$ は軌道を予測するための多層パーセプトロンです。

**スコア生成**
- **スコアの計算**:
  - 同様に、クエリセットはスコア生成用のMLPに入力され、各軌道に対応する信頼度スコア $\pi_0$ が計算されます。このスコアは、生成された軌道がどれだけ信頼できるか、あるいは適切であるかを評価します。
  ```math
  \pi_0 = \text{MLP}_{score}(Q_i)
  ```
  - ここでは、$Q_i$ は同じくクロスアテンションを適用した後のクエリで、$\text{MLP}_{score}$ はスコアを予測するための多層パーセプトロンです。

**最適軌道の選択**
- **軌道とスコアの統合**:
  - 最終的に、生成された軌道 $T_0$ とスコア $\pi_0$ が統合され、複数の候補軌道の中から最適な軌道が選択されます。この選択プロセスは、安全性、快適性、効率性の観点から最適な運転行動を決定するために非常に重要です。
  - モデルはこの軌道を基にして、次にどのような行動を取るべきかを決定します。

# 4. Experiment

第4章は「実験と評価」に関する内容で、PLUTOフレームワークの性能を評価するための実験設定、結果、考察、アブレーションスタディに焦点を当てています。以下に、テーブルも含めて詳しく解説します。

---

##　**4.1 実験設定**

**使用データセット: nuPlan**
- **nuPlanデータセット**を使用して、PLUTOモデルのトレーニングと評価が行われました。このデータセットには、1,300時間の実運転データが含まれており、75種類のシナリオラベルが付けられています。nuPlanは、大規模な自律運転のベンチマークであり、シミュレーションと実データの組み合わせを特徴としています。

## **ベンチマークと評価基準**
- 評価は**Val14**ベンチマークを使用し、14種類のシナリオタイプから選ばれた100のシナリオに基づいて行われました。
- 使用された評価指標には、**オープンループスコア**、**非リアクティブな閉ループスコア**、および**リアクティブな閉ループスコア**が含まれます。特に、閉ループスコアに重点が置かれており、モデルが予測に基づいて環境とどのように相互作用するかが評価されます。

---

## **4.2 結果と考察**

**PLUTOの性能**
- PLUTOモデルは、**PDM-Closed**などのルールベースのプランナーを初めて上回る結果を示し、これまでの学習ベースの手法を超える性能を達成しました。
- 特に、PLUTOは**PlanTF**モデルに対して大幅な改善を示し、安全性指標での向上が特に顕著でした。

**テーブル 1: 各モデルの比較**
- **Table 1**では、PLUTOと他の最先端モデルとの比較結果が示されています。具体的な数値としては、PLUTOがPlanTFを含む他のモデルよりも優れたパフォーマンスを示していることが分かります。
- 参考 [Table-1](./Explanations/Table_1.md)
- 参考 [Table-2](./Explanations/Table_2.md)

**定性的な結果**
- **PLUTOの動作例**が示されており、ラウンドアバウトでの運転や車線変更など、複雑なシナリオでの優れた運転計画能力が強調されています。
- これらのシナリオでは、PLUTOは人間のような多様で動的な運転行動を示しており、他のエージェントと円滑に相互作用しています。

---

## **4.3 アブレーションスタディ**

- **縦方向クエリの数**の影響に関しては、12個のクエリが最適であることが示され、それ以上の増加は逆に性能を低下させることが分かりました。

**学習ベースのスコアの影響**
- **Table 3**では、学習ベースのスコアとルールベースのスコアの組み合わせが示されています。特に、学習ベースのスコアがルールベースのスコアと適切に組み合わせられると、最適な性能が得られることが示されています。
- 参考 [Table-3](./Explanations/Table_3.md)

**予測モデルの影響**
- **予測モデル**についても言及されており、PLUTOに組み込まれた学習された予測モデルが、従来の定速予測モデルよりも優れたパフォーマンスを提供することが示されています。


# 5. RESULTS AND D ISSCUSION

第5章では、PLUTOのパフォーマンスを従来の最先端手法と比較し、PLUTOの優位性を定量的および定性的に評価しています。この章では、主に閉ループシミュレーションの結果を中心に、モデルのパフォーマンスを詳細に分析しています。

## **5.1 パフォーマンスの定量評価**

このセクションでは、PLUTOが従来のプランナーと比較して、どのようにパフォーマンスが向上したかを詳細に説明しています。以下のような評価指標が使用され、それぞれについてPLUTOがどのように優れているかを示しています。

1. **衝突率（Collisions Rate）**:
   - PLUTOは、他の従来のプランニング手法に比べて、衝突率が大幅に低いことが示されています。これは、PLUTOがより安全な運転計画を生成し、シナリオの複雑さに対処できる能力が高いことを示唆しています。
   - 特に、混雑した都市環境や複数のエージェントが関与するシナリオにおいて、PLUTOは安全性の面で優位に立っています。

2. **走行可能領域の維持率（Drivable Area Compliance）**:
   - PLUTOは、走行可能な領域内にエゴビークルを維持する能力においても他の手法を上回っています。これは、モデルが道路の境界を理解し、それを遵守する能力が優れていることを示しています。
   - 他のモデルと比較して、PLUTOは走行可能領域から逸脱するケースが少なく、法規遵守の度合いが高いと評価されています。

3. **乗り心地（Comfort）**:
   - PLUTOは、急加速や急減速を避けることで、乗り心地の向上にも成功しています。これにより、実際の運転シナリオでのユーザーエクスペリエンスが向上します。
   - 他のモデルに比べて、PLUTOはよりスムーズな運転軌道を生成し、快適性の面でも優れた性能を発揮しています。

4. **時間的効率（Temporal Efficiency）**:
   - PLUTOは目的地に迅速に到達する能力においても優れた結果を示しています。これは、効率的な経路計画と迅速な意思決定が可能であることを意味します。
   - 他の手法と比較して、PLUTOは遅延や迂回を最小限に抑えることで、目的地への到達時間を短縮しています。

## **5.2 パフォーマンスの定性的評価**

このセクションでは、定性的な視点からPLUTOのパフォーマンスを評価しています。実際のシナリオでの運転行動や、エージェント間の相互作用についての観察が含まれます。

1. **複雑なシナリオでの対応力**:
   - PLUTOは、複数のエージェントが関与する複雑なシナリオでも優れたパフォーマンスを発揮します。これは、PLUTOが他のエージェントの動きを予測し、それに基づいて適切な運転計画を立てる能力が高いことを示しています。
   - 特に、都市部の交差点やラウンドアバウトなどの複雑な環境で、PLUTOの計画能力が際立っています。

2. **人間らしい運転行動**:
   - PLUTOは、他の手法と比較して、より人間らしい運転行動を生成します。これは、モデルが多様な運転スタイルや状況に柔軟に対応できることを示しています。
   - PLUTOの運転計画は、実際の人間ドライバーの行動に近いものであり、急なハンドル操作やブレーキ操作が少ないことが特徴です。

3. **エージェントとの相互作用**:
   - 他のエージェントとの相互作用においても、PLUTOは非常に優れた結果を示しています。これは、モデルが他の車両や歩行者の動きを予測し、それに応じた適切な行動をとることができることを意味します。
   - 特に、ラウンドアバウトや交差点での他のエージェントとの協調的な動きが評価されています。

## **5.3 アブレーションスタディ**

このセクションでは、PLUTOの各コンポーネントがモデルの性能にどのように寄与しているかを分析しています。各コンポーネントを取り除いた場合のパフォーマンスの変化が評価されています。

1. **クエリの数と配置の影響**:
   - PLUTOでは、クエリの数と配置が運転計画の精度に大きな影響を与えることが確認されています。最適な数のクエリを使用することで、計画精度が向上し、衝突回避能力も向上します。
   - 過剰なクエリは計算コストを増加させ、逆にパフォーマンスを低下させるため、バランスが重要です。

2. **クロスアテンションの重要性**:
   - クロスアテンションメカニズムは、PLUTOの運転計画において非常に重要な役割を果たしています。このメカニズムを取り除くと、モデルの環境理解が不十分になり、衝突率が増加することが示されています。
   - クロスアテンションは、シーンの重要な要素を正確に捉え、それに基づいて適切な運転行動を生成するために不可欠です。

## **結論**
- 第5章では、PLUTOの優れたパフォーマンスが、従来のプランニング手法と比較して、どのように際立っているかが詳細に示されています。定量的な評価と定性的な評価の両面から、PLUTOの運転計画能力が強調されており、特に複雑なシナリオでの安全性と効率性が高く評価されています。

 


