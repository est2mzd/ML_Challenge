# FAQ

## Q: 前処理（キャッシュ）が非常に時間がかかる
A: **前処理はファイルI/Oがボトルネックになっている可能性があります**。  
データセットが十分なI/O帯域幅を持つ場所（例: *ローカルSSD*）に配置されていることを確認してください。  
私たちの特徴量ビルダーはデータベースファイルをクエリするため、I/O帯域幅が不足しているとクエリ速度が低下します。また、前処理したいサンプル数を確認してください（次の項目で詳細を説明します）。

---

## Q: どのくらいのサンプル数を使用すべきですか？ / データセットサイズ / サブサンプリング
A: **データセット全体を徹底的に前処理することは必ずしも理想的ではありません**。  
デフォルトでは`NuPlanScenario`を使用しており、データベース内のタイムステップごとに1つのサンプルを生成します（`20Hz`と非常に高密度です）。  
例えば、`scenario_filter.limit_total_scenarios=0.1`を設定することで`2Hz`に削減され、サンプル数を`1/10`に減らすことができます。  
このサンプリングレートは、入力/ターゲット特徴量で使用される頻度とは独立している可能性があります。特徴量を抽出する際には、カスタマイズされた`FeatureBuilder`や`TargetBuilder`で、希望する入力/ターゲット特徴量のサンプリングレートを設定することができます。

---

## Q: 勾配がNaNになる / 数値的な安定性 / 浮動小数点精度
A: **FP16（半精度浮動小数点）は数値的不安定性の問題を引き起こします**。  
モデルの詳細な調査を行う前に、`lightning.trainer.params.precision`が`32`に設定されていることを確認してください。  
デフォルトの[設定](https://github.com/motional/nuplan-devkit/blob/master/nuplan/planning/script/config/training)では、`lightning.trainer.params.precision=16`が設定されており、FP16がトレーニングに使用されます。  
FP16を使用してもモデルが数値的に安定していることに100%確信が持てない場合は、常にFP32を使用してください。
