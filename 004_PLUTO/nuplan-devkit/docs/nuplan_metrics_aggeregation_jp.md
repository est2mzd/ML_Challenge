# 最終評価指標構造 (Final Metric Structure)

このドキュメントでは、NuPlanでの自動運転車（AV）のプランナー性能を比較するために、評価指標がどのように集約され、最終スコア構造が生成されるかを説明します。

---

## 個別の評価指標スコア

Challenge 1、およびChallenge 2と3では、プランナー評価のために異なる評価指標が使用されます。各シナリオスコア内の指標には、プランナーの性能に応じて0〜1の間のスコアが割り当てられます。スコアが高いほど、その指標に基づく性能が優れていることを示します。指標の詳細については、以下の表や[metrics_description](https://github.com/motional/nuplan-devkit/blob/master/docs/metrics_description.md)を参照してください。

---

## Challenge 1: 提案された軌跡に基づくシナリオスコア

各シナリオでは、選択された指標が集約されて提案された軌跡のスコアが算出されます。現在、集約関数は個別指標スコアの**階層型加重平均関数**です。

- ミス率が指定された閾値を超える場合、シナリオのスコアは0となります。
- ミス率が閾値内の場合、他の指標スコアの加重平均がシナリオスコアとして使用されます。

| 評価指標名            | スコアの計算方法                                                         | シナリオスコアでの重み |
|--------------------|-------------------------------------------------------------------|-------------------|
| Miss Rate Within Bound | プランナー提案軌跡とエキスパート軌跡の最大変位誤差が`max_displacement_threshold`を超え、シナリオの時間インスタンスのうち`max_miss_rate_threshold`を超える場合スコアは0、それ以外は1。 | NA（乗算指標）       |
| Average Displacement Error (ADE)  Within Bound        | ADEの平均が`max_average_l2_error_threshold`を超える場合スコアは0、それ以外は1。 | 1                 |
| Final Displacement Error (FDE)  Within Bound        | FDEの平均が`max_final_l2_error_threshold`を超える場合スコアは0、それ以外は1。 | 1                 |
| Average Heading Error (AHE) Within Bound        | AHEの平均が`max_average_heading_error_threshold`を超える場合スコアは0、それ以外は1。 | 2                 |
| Final Heading Error (FHE) Within Bound       | FHEの平均が`max_final_heading_error_threshold`を超える場合スコアは0、それ以外は1。 | 2                 |

---

## Challenge 2・3: 実行された軌跡に基づくシナリオスコア

各シナリオでは、選択された指標が集約されて実行された軌跡のスコアが算出されます。集約関数は、**階層型加重平均関数**です。

### スコア計算条件
- 以下の条件に該当する場合、スコアは0となります：
  - 車両や歩行者（VRU）との「責任のある衝突」が発生。
  - 複数の物体（例: コーン）との「責任のある衝突」が発生。
  - 走行可能領域の逸脱が発生。
  - 自車が逆走し6m以上進行。
  - 自車が十分な進行を達成していない。

- 以下の場合、他の指標スコアの加重平均に0.5を掛けます：
  - 単一の物体（例: コーン）との「責任のある衝突」。
  - 自車が逆走し2m以上（6m未満）進行。

- 上記に該当しない場合、他の指標スコアの加重平均がシナリオスコアとして使用されます。

| 評価指標名                 | スコアの計算方法                                                                                          | シナリオスコアでの重み |
|--------------------------|--------------------------------------------------------------------------------------------------|-------------------|
| no_ego_at_fault_collisions | 車両やVRUとの責任のある衝突、または複数の物体との衝突がある場合スコアは0。単一の物体との衝突がある場合スコアは0.5。それ以外は1。 | NA（乗算指標）       |
| drivable_area_compliance  | 自車の境界ボックスが走行可能領域から`max_violation_threshold`以上逸脱した場合スコアは0。それ以外は1。                  | NA（乗算指標）       |
| driving_direction_compliance | `time_horizon`内で逆走が`driving_direction_compliance_threshold`以下の場合スコアは1、`driving_direction_violation_threshold`を超える場合スコアは0、それ以外は0.5。 | 5                 |
| time_to_collision_within_bound | `least_min_ttc`閾値未満の場合スコアは0。それ以外は1。                                                   | 5                 |
| speed_limit_compliance    | スピード違反がない場合スコアは1、違反が増えるほど0に近づく。                                                  | 4                 |
| ego_progress_along_expert_route | `overall_ego_progress`が負の場合スコアは0。それ以外はエキスパートルート進行率に基づいてスコアを計算。                                  | 5                 |
| ego_is_making_progress    | `ego_progress_along_expert_route`が`min_progress_threshold`未満の場合スコアは0、それ以外は1。                        | NA（乗算指標）       |
| Ego_is_comfortable        | 快適性指標（加速度やジャーク）がすべて閾値内の場合スコアは1。それ以外は0。                                          | 2                 |

---

## シナリオタイプごとのプランナースコア

nuPlanでは、シナリオを自車・エージェント・シーンの特徴に基づいてタイプ分けしています。特定のシナリオタイプに属する軌跡スコアを平均することで、そのタイプにおけるプランナーのスコアを算出します。このスコアを利用して、プランナーが性能を改善すべきシナリオタイプを特定できます。特に機械学習（ML）ベースのプランナーに有効です。

---

## プランナーの最終スコア

プランナーは、複数のシナリオでの性能に基づき、0〜1のスコアが割り当てられます。スコアが高いほど性能が優れていることを示します。プランナーの最終スコアを算出するには、N個のシナリオでプランナーを実行し、これらのシナリオにおける軌跡スコアの平均を計算します。
